<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QDS • GrowthHub — Revenue Floor + Capacity Truth (v5.2)</title>
<style>
  :root{
    --bg:#060b14;
    --panel:#0b1220;
    --panel2:#0a111e;
    --text:#e9f1ff;
    --muted:#9fb0c9;
    --border:rgba(255,255,255,0.08);
    --shadow:0 0 0 1px rgba(255,255,255,0.06), 0 18px 40px rgba(0,0,0,0.45);

    --accent:#7fb3ff;
    --mint:#7fffd4;
    --teal:#4de3ff;
    --lime:#93ff8c;
    --warn:#ffd479;
    --bad:#ff7f9d;

    --r:18px;
    --r2:24px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    color:var(--text);
    background: var(--bg);
  }

  .wrap{max-width:980px;margin:0 auto;padding:18px 14px 60px}
  .hero{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid var(--border);
    border-radius:var(--r2);
    box-shadow:var(--shadow);
    padding:18px;
    margin-bottom:14px;
  }
  h1{margin:0 0 6px;font-size:20px;letter-spacing:0.2px}
  .sub{color:var(--muted);font-size:13px;line-height:1.35}
  .pillRow{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .pill{
    display:flex;gap:10px;align-items:flex-start;
    padding:10px 12px;border:1px solid var(--border);
    border-radius:999px;background:rgba(0,0,0,0.18);
    color:var(--muted);font-size:12.5px
  }
  .dot{width:10px;height:10px;border-radius:99px;margin-top:3px;background:var(--accent);box-shadow:0 0 0 4px rgba(127,179,255,0.10)}
  .dot.m{background:var(--mint);box-shadow:0 0 0 4px rgba(127,255,212,0.10)}
  .dot.t{background:var(--teal);box-shadow:0 0 0 4px rgba(77,227,255,0.10)}

  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    color:var(--text);
    padding:10px 12px;border-radius:999px;
    font-weight:650;
    cursor:pointer;
  }
  button:active{transform:translateY(1px)}
  button.secondary{background:rgba(0,0,0,0.18);color:var(--muted)}
  button.warn{border-color:rgba(255,212,121,0.28)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid var(--border);
    border-radius:var(--r2);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06)}
  .cardHead h2{margin:0;font-size:15px}
  .hint{margin-top:4px;color:var(--muted);font-size:12.5px}
.trustline{margin-top:4px;color:var(--muted);font-size:12.5px;font-style:italic}

  .cardBody{padding:14px 16px}
  .row{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px}
  @media(min-width:520px){.row{grid-template-columns:1fr 1fr}}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:12.5px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
  label .k{opacity:0.8}
  input,select,textarea{
    width:100%;
    border:1px solid rgba(255,255,255,0.09);
    background:rgba(0,0,0,0.24);
    color:var(--text);
    border-radius:14px;
    padding:12px 12px;
    outline:none;
    font-size:15px;
  }
  textarea{min-height:72px;resize:vertical}
  .miniBtnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .miniBtnRow button{padding:9px 11px;font-size:13px}

  .outGrid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:520px){.outGrid{grid-template-columns:1fr 1fr}}
  .kpi{
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(0,0,0,0.18);
    border-radius:var(--r2);
    padding:14px 14px;
  }
  .kpi .t{color:var(--muted);font-size:12.5px}
  .kpi .v{font-size:36px;letter-spacing:0.2px;font-weight:850;margin-top:6px}
  .kpi .s{margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.3}
  .kpi .v.small{font-size:30px}

  .hr{height:1px;background:rgba(255,255,255,0.06);margin:12px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left}
  th{color:var(--muted);font-weight:700;font-size:12.5px}
  td{font-size:14px}
  .pos{color:var(--lime);font-weight:800}
  .neg{color:var(--bad);font-weight:800}
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.18);
    color:var(--muted);
    font-size:12px;font-weight:750;
  }
  .chip .b{width:9px;height:9px;border-radius:99px;background:var(--accent)}
  .chip.low .b{background:var(--warn)}
  .chip.high .b{background:var(--lime)}
  .noteBox{
    margin-top:8px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(0,0,0,0.18);
    border-radius:18px;
    padding:10px 12px;
    color:var(--muted);
    font-size:12.5px;
    line-height:1.35;
  }

  .hide{display:none !important}

/* PATCH: kill banding lines (opaque surfaces, no blur) */
html,body{background:#0b0f16 !important;}
/* if you have any background FX layers, hard-disable */
body::before, body::after, .bg, .bgfx, .noise, .vignette{background:none !important;content:none !important;display:none !important;}
/* blur/transparency = banding city on mobile GPU */
*{backdrop-filter:none !important;-webkit-backdrop-filter:none !important;}
/* make the big UI surfaces opaque + remove gradient/shadow tricks */
.card,.panel,.section,.box,.tile,.inputs,.outputs,.grid,.row,
input,select,textarea,button{
  background:#0f1622 !important;
  background-image:none !important;
  box-shadow:none !important;
}
input,select,textarea{border:1px solid rgba(255,255,255,.10) !important;}


/* PATCH: pro flat bg + no seams (replaces big gradient) */
:root{
  --bg0:#0b0f16; --bg1:#0e1624;
  --card:#0f1622; --stroke:rgba(255,255,255,.10);
  --muted:rgba(255,255,255,.72);
}

/* hard-reset any old gradient layers */
html,body{background:var(--bg0) !important; color-scheme:dark;}
body{
  background-color:var(--bg0) !important;
  background-image:
    radial-gradient(1200px 600px at 50% -220px, rgba(120,140,255,.12), transparent 62%),
    radial-gradient(900px 500px at 12% 10%, rgba(0,255,200,.05), transparent 58%),
    radial-gradient(900px 500px at 88% 14%, rgba(255,200,0,.04), transparent 58%);
  background-repeat:no-repeat !important;
  background-attachment:scroll !important;
}

/* subtle dithering hides any remaining GPU banding */
body::after{
  content:"";
  position:fixed; inset:0;
  pointer-events:none;
  opacity:.055;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
  mix-blend-mode:overlay;
}

/* THIS is where the seams usually come from: translucency + blur */
*{-webkit-backdrop-filter:none !important; backdrop-filter:none !important;}
.card,.panel,.section,.box,.tile,.inputs,.outputs,.grid,.row,
input,select,textarea,button{
  background:var(--card) !important;
  background-image:none !important;
  border:1px solid var(--stroke) !important;
  box-shadow:none !important; /* kill big soft shadows = seams */
}
small,.hint,.sub,.muted{color:var(--muted) !important;}


/* PATCH: flat bg (kills banding), restore rounded corners */
:root{ --radius:18px; }

/* kill any overlay/noise layer we added earlier */
body::after{ content:none !important; display:none !important; opacity:0 !important; }

/* go FULL flat: no gradients, no glows */
html,body{ background:#0b0f16 !important; }
body{
  background-color:#0b0f16 !important;
  background-image:none !important;
}

/* restore the “premium” rounding everywhere it matters */
.card,.panel,.section,.box,.tile,.inputs,.outputs,.grid,.row,
input,select,textarea,button{
  border-radius:var(--radius) !important;
  overflow:hidden; /* stops inner seams at corners */
  -webkit-appearance:none;
}

/* keep borders subtle so the radius reads */
.card,.panel,.section,.box,.tile,.inputs,.outputs,.grid,.row{
  border:1px solid rgba(255,255,255,.10) !important;
}

</style>
<link rel="stylesheet" href="_os/qds_os.css">
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1>QDS • GrowthHub — Revenue Floor + Capacity Truth <span class="mono" style="color:var(--muted)">(v5.2)</span></h1>
    <div class="sub">
      Single-file demo: demand → conversion → capacity caps → bookings → MRR accumulation (with churn).<br/>
      <b>Clarity:</b> shows <b>Bookings</b> vs <b>Cash-in at horizon</b>. Built for honest planning, not hype. <span style="color:var(--warn)">DEMO</span>
    </div>

    <div class="btnRow">
      <button id="btnToggle">Toggle One-Pager View</button>
      <button id="btnPrint" class="secondary">Print One-Pager</button>
      <button id="btnCopy" class="secondary">Copy Board Summary</button>
      <button id="btnReset" class="warn">Reset to Base</button>
    </div>

    <div class="pillRow">
      <div class="pill"><span class="dot"></span><b>Purpose:</b> revenue floor under realistic conversion + caps</div>
      <div class="pill"><span class="dot m"></span><b>Output:</b> bookings, cash-in, MRR @ horizon</div>
      <div class="pill"><span class="dot t"></span><b>Truth:</b> caps stop “infinite sprints” fantasy</div>
    </div>
  </div>

  <div class="grid">
    <div class="card" id="cardInputs">
      <div class="cardHead">
        <h2>Inputs</h2>
        <div class="hint">Preset → sane defaults. Rates are 0–1. Churn is entered as %.</div>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="field">
            <label>Preset <span class="k">Mode</span></label>
            <select id="preset">
              <option value="base">Base</option>
              <option value="conservative">Conservative</option>
              <option value="optimistic">Optimistic</option>
            </select>
          </div>

          <div class="field">
            <label>Currency label (display) <span class="k">Symbol only</span></label>
            <input id="sym" value="£"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Months to project <span class="k">MRR horizon</span></label>
            <input id="months" type="number" step="1" value="12"/>
          </div>
          <div class="field">
            <label>Starting MRR <span class="k">M0</span></label>
            <input id="m0" type="number" step="1" value="0"/>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field">
            <label>Leads / month <span class="k">L</span></label>
            <input id="L" type="number" step="0.1" value="6"/>
          </div>
          <div class="field">
            <label>Qualified rate (0–1) <span class="k">q</span></label>
            <input id="q" type="number" step="0.01" value="0.40"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Sprint close of qualified (0–1) <span class="k">s</span></label>
            <input id="s" type="number" step="0.01" value="0.25"/>
          </div>
          <div class="field">
            <label>Pilot-from-sprint (0–1) <span class="k">p</span></label>
            <input id="p" type="number" step="0.01" value="0.30"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Retainer-from-pilot (0–1) <span class="k">r</span></label>
            <input id="r" type="number" step="0.01" value="0.20"/>
          </div>
          <div class="field">
            <label>Monthly churn % <span class="k">c</span></label>
            <input id="c" type="number" step="0.1" value="3.0"/>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field">
            <label>Sprint price <span class="k">/ sprint</span></label>
            <input id="sprintPrice" type="number" step="50" value="2500"/>
          </div>
          <div class="field">
            <label>Pilot price <span class="k">/ pilot</span></label>
            <input id="pilotPrice" type="number" step="50" value="3500"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Retainer / month <span class="k">/ mo</span></label>
            <input id="retainerMonth" type="number" step="25" value="800"/>
          </div>
          <div class="field">
            <label>Cost base / month (optional) <span class="k">£</span></label>
            <input id="cost" type="number" step="10" value="0"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Max sprints / month <span class="k">Smax</span></label>
            <input id="Smax" type="number" step="1" value="2"/>
          </div>
          <div class="field">
            <label>Max pilots / month <span class="k">Pmax</span></label>
            <input id="Pmax" type="number" step="1" value="1"/>
          </div>
        </div>

        <div class="field">
          <label>Notes (optional) <span class="k">assumption context</span></label>
          <textarea id="notes" placeholder="e.g., 2 days/week available; partner work pending; outbound leads from X; etc."></textarea>
        </div>

      </div>
    </div>

    <div class="card" id="cardOutputs">
      <div class="cardHead">
        <h2>Live Outputs</h2>
        <div class="trustline">Caps only matter when demand exceeds capacity; otherwise they're inactive.</div>
<div class="hint">Bookings vs Cash-in. Honest caps + churned MRR.</div>
      </div>
      <div class="cardBody">
        <div class="outGrid">
          <div class="kpi">
            <div class="t">Bookings / Month</div>
            <div class="v" id="kBookings">—</div>
            <div class="s">Sprints + Pilots + <b>New</b> MRR (what you just sold this month)</div>
          </div>

          <div class="kpi">
            <div class="t">Bookings / Year (Run-Rate)</div>
            <div class="v" id="kBookingsYear">—</div>
            <div class="s">12 × bookings/month (capacity-capped)</div>
          </div>

          <div class="kpi">
            <div class="t">New contracted MRR added this month</div>
            <div class="v small" id="kNewMRR">—</div>
            <div class="s">From new retainers</div>
          </div>

          <div class="kpi">
            <div class="t">MRR @ Horizon</div>
            <div class="v small" id="kMRRHor">—</div>
            <div class="s">MRR after churn @ chosen months</div>
          </div>

          <div class="kpi">
            <div class="t">Cash-in / Month @ Horizon</div>
            <div class="v" id="kCashIn">—</div>
            <div class="s">Sprints + Pilots + <b>Current</b> MRR at horizon</div>
          </div>

          <div class="kpi">
            <div class="t">Cash-in / Year @ Horizon</div>
            <div class="v" id="kCashInYear">—</div>
            <div class="s">12 × cash-in/month at horizon</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="mono" style="color:var(--muted);font-size:12.5px;line-height:1.45" id="kVolumes">—</div>

        <div class="hr"></div>

        <div class="mono" style="color:var(--muted);font-size:12.5px;line-height:1.55" id="kMRRTrack">—</div>

        <div class="hr"></div>

        <div class="noteBox">
          <b>Board summary (auto)</b>
          <div id="kBoard" style="margin-top:6px"></div>
          <div style="margin-top:8px;opacity:0.85">This line is designed to be copy-safe for meetings.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="cardHead">
      <h2>What Moves the Needle (Sensitivity)</h2>
      <div class="hint">Simple local deltas on bookings run-rate. Good enough for decision chat; not pretending to be full Monte Carlo.</div>
    </div>
    <div class="cardBody">
      <table>
        <thead>
          <tr>
            <th>Change</th>
            <th>Δ Yearly Run-Rate</th>
            <th>≈ Δ Per Month</th>
          </tr>
        </thead>
        <tbody id="sensRows"></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="cardHead">
      <h2>Assumption Audit</h2>
      <div class="hint">Evidence notes are full-width under each row (no off-screen).</div>
    </div>
    <div class="cardBody" id="auditBody"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="cardHead">
      <h2>Persistence</h2>
      <div class="hint">Save your assumptions between sessions</div>
    </div>
    <div class="cardBody">
      <div class="miniBtnRow">
        <button id="btnSaveLS">Save to localStorage</button>
        <button id="btnLoadLS">Load from localStorage</button>
        <button id="btnDefaults">Load defaults</button>
      </div>
      <div class="mono" style="margin-top:10px;color:var(--muted);font-size:12.5px">
        Stored key: <span style="color:var(--mint);font-weight:800">QDS_GrowthHub_RevenueFloor_v5_2</span>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const KEY = "QDS_GrowthHub_RevenueFloor_v5_2";

  // presets: churn stored as FRACTION (0.03 = 3%)
  const presets = {
    conservative: {
      L:4, q:0.35, s:0.20, p:0.25, r:0.15,
      sprintPrice:2200, pilotPrice:3200, retainerMonth:650,
      Smax:1, Pmax:1, months:12, m0:0, c:0.035, cost:0
    },
    base: {
      L:6, q:0.40, s:0.25, p:0.30, r:0.20,
      sprintPrice:2500, pilotPrice:3500, retainerMonth:800,
      Smax:2, Pmax:1, months:12, m0:0, c:0.03, cost:0
    },
    optimistic: {
      L:10, q:0.50, s:0.30, p:0.35, r:0.25,
      sprintPrice:3000, pilotPrice:4200, retainerMonth:1000,
      Smax:3, Pmax:2, months:12, m0:0, c:0.025, cost:0
    }
  };

  function clamp01(x){ x=Number(x); if(!isFinite(x)) return 0; return Math.max(0, Math.min(1, x)); }
  function num(x, def=0){ x=Number(x); return isFinite(x) ? x : def; }

  function sym(){
    const s = String($("sym").value || "£").trim();
    return s.length ? s : "£";
  }

  function fmtMoney(x){
    const s = sym();
    if(!isFinite(x)) return "—";
    const v = Math.round(x);
    return s + v.toLocaleString(undefined,{maximumFractionDigits:0});
  }

  function fmtMoneySigned(x){
    const s = sym();
    if(!isFinite(x)) return "—";
    const sign = x>0 ? "+" : (x<0 ? "−" : "±");
    const v = Math.round(Math.abs(x));
    return sign + s + v.toLocaleString(undefined,{maximumFractionDigits:0});
  }

  function readInputs(){
    // churn entered as % in UI -> fraction internally
    const cFrac = Math.min(0.99, Math.max(0, num($("c").value)/100));
    return {
      L: Math.max(0, num($("L").value)),
      q: clamp01($("q").value),
      s: clamp01($("s").value),
      p: clamp01($("p").value),
      r: clamp01($("r").value),

      sprintPrice: Math.max(0, num($("sprintPrice").value)),
      pilotPrice: Math.max(0, num($("pilotPrice").value)),
      retainerMonth: Math.max(0, num($("retainerMonth").value)),

      Smax: Math.max(0, num($("Smax").value)),
      Pmax: Math.max(0, num($("Pmax").value)),

      months: Math.max(0, Math.floor(num($("months").value))),
      m0: Math.max(0, num($("m0").value)),
      c: cFrac,
      cost: Math.max(0, num($("cost").value)),
      notes: String($("notes").value || "")
    };
  }

  // Core model:
  // - bookings/mo = one-offs + NEW MRR (from new retainers)
  // - MRR accumulates with churn: mrr(t)=mrr(t-1)*(1-c)+newMRR
  // - cash-in/mo at horizon = one-offs + MRR(horizon)
  function model(inp){
    const L = Math.max(0, Number(inp.L)||0);
    const q = clamp01(inp.q), s = clamp01(inp.s), p = clamp01(inp.p), r = clamp01(inp.r);

    const sprintPrice   = Math.max(0, Number(inp.sprintPrice)||0);
    const pilotPrice    = Math.max(0, Number(inp.pilotPrice)||0);
    const retainerMonth = Math.max(0, Number(inp.retainerMonth)||0);

    const Smax = (isFinite(inp.Smax) && Number(inp.Smax) >= 0) ? Number(inp.Smax) : Infinity;
    const Pmax = (isFinite(inp.Pmax) && Number(inp.Pmax) >= 0) ? Number(inp.Pmax) : Infinity;

    const months = Math.max(0, Math.floor(Number(inp.months)||0));
    const c = clamp01(inp.c);
    const m0 = Math.max(0, Number(inp.m0)||0);
    const cost = Math.max(0, Number(inp.cost)||0);

    const qualified = L * q;

    const sprintsRaw = qualified * s;
    const sprints = Math.min(sprintsRaw, Smax);

    const pilotsRaw = sprints * p;
    const pilots = Math.min(pilotsRaw, Pmax);

    const newRetainers = pilots * r;
    const newMRRMo = newRetainers * retainerMonth;

    const oneOffMo = sprints * sprintPrice + pilots * pilotPrice;
    const bookingsMo = oneOffMo + newMRRMo;

    // MRR track
    const mrrTrack = [];
    let mrr = m0;
    for(let t=1; t<=months; t++){
      mrr = mrr * (1 - c) + newMRRMo;
      mrrTrack.push(mrr);
    }

    function mAt(month){
      if(month <= 0) return m0;
      if(mrrTrack.length === 0) return m0;
      if(month >= mrrTrack.length) return mrrTrack[mrrTrack.length - 1];
      return mrrTrack[month - 1];
    }

    const mrrHorizon = mAt(months);
    const cashInMoHorizon = oneOffMo + mrrHorizon;

    return {
      qualified, sprintsRaw, sprints, pilotsRaw, pilots, newRetainers,
      oneOffMo, newMRRMo, bookingsMo,
      mrrTrack, mrrHorizon, mrr3:mAt(3), mrr6:mAt(6), mrr12:mAt(12),
      cashInMoHorizon,
      cost,
      bookingsYear: bookingsMo * 12,
      cashInYearHorizon: cashInMoHorizon * 12,
      netBookingsMo: bookingsMo - cost,
      netCashInMoHorizon: cashInMoHorizon - cost
    };
  }

  function setPreset(name){
    const p = presets[name] || presets.base;
    $("L").value = p.L;
    $("q").value = p.q;
    $("s").value = p.s;
    $("p").value = p.p;
    $("r").value = p.r;
    $("sprintPrice").value = p.sprintPrice;
    $("pilotPrice").value = p.pilotPrice;
    $("retainerMonth").value = p.retainerMonth;
    $("Smax").value = p.Smax;
    $("Pmax").value = p.Pmax;
    $("months").value = p.months;
    $("m0").value = p.m0;
    $("c").value = (p.c * 100).toFixed(1);
    $("cost").value = p.cost;
    update();
  }

  function saveLS(){
    const payload = readInputs();
    payload.sym = String($("sym").value||"£");
    payload.preset = String($("preset").value||"base");
    localStorage.setItem(KEY, JSON.stringify(payload));
  }

  function loadLS(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return false;
    let p;
    try{ p = JSON.parse(raw); }catch(e){ return false; }
    if(p.sym!=null) $("sym").value = String(p.sym);
    if(p.preset) $("preset").value = String(p.preset);

    // Write values back (keep churn % in UI)
    $("L").value = p.L ?? $("L").value;
    $("q").value = p.q ?? $("q").value;
    $("s").value = p.s ?? $("s").value;
    $("p").value = p.p ?? $("p").value;
    $("r").value = p.r ?? $("r").value;

    $("sprintPrice").value = p.sprintPrice ?? $("sprintPrice").value;
    $("pilotPrice").value = p.pilotPrice ?? $("pilotPrice").value;
    $("retainerMonth").value = p.retainerMonth ?? $("retainerMonth").value;

    $("Smax").value = p.Smax ?? $("Smax").value;
    $("Pmax").value = p.Pmax ?? $("Pmax").value;

    $("months").value = p.months ?? $("months").value;
    $("m0").value = p.m0 ?? $("m0").value;

    // stored c is fraction; UI wants %
    if(p.c!=null) $("c").value = (Number(p.c)*100).toFixed(1);

    $("cost").value = p.cost ?? $("cost").value;
    $("notes").value = p.notes ?? $("notes").value;

    update();
    return true;
  }

  function copyText(txt){
    const t = document.createElement("textarea");
    t.value = txt;
    document.body.appendChild(t);
    t.select();
    document.execCommand("copy");
    document.body.removeChild(t);
  }

  function mkChip(level){
    const c = document.createElement("span");
    c.className = "chip " + (level==="Low"?"low":(level==="High"?"high":""));
    const b = document.createElement("span");
    b.className = "b";
    c.appendChild(b);
    c.appendChild(document.createTextNode(" " + level));
    return c;
  }

  function auditRow(name, val, level, note){
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "14px";

    const top = document.createElement("div");
    top.style.display = "grid";
    top.style.gridTemplateColumns = "1fr 120px 120px";
    top.style.gap = "10px";
    top.style.alignItems = "center";

    const a = document.createElement("div");
    a.style.color = "var(--text)";
    a.style.fontWeight = "800";
    a.textContent = name;

    const v = document.createElement("div");
    v.className = "mono";
    v.style.color = "var(--text)";
    v.style.textAlign = "left";
    v.textContent = val;

    const c = document.createElement("div");
    c.appendChild(mkChip(level));

    top.appendChild(a); top.appendChild(v); top.appendChild(c);
    wrap.appendChild(top);

    const nb = document.createElement("div");
    nb.className = "noteBox";
    nb.innerHTML = "<b>Evidence note:</b> " + escapeHtml(note);
    wrap.appendChild(nb);

    const hr = document.createElement("div");
    hr.style.height = "1px";
    hr.style.background = "rgba(255,255,255,0.06)";
    hr.style.marginTop = "14px";
    wrap.appendChild(hr);

    return wrap;
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function sensTable(inp){
    const base = model(inp);
    const baseYear = base.bookingsYear;

    // Local deltas (simple, readable)
    const tests = [
      {label:"+1 lead / month", apply:(x)=>({ ...x, L:x.L+1 })},
      {label:"+0.10 sprint close rate", apply:(x)=>({ ...x, s:Math.min(1, x.s+0.10) })},
      {label:"+1 sprint capacity (0 if cap not binding)", apply:(x)=>({ ...x, Smax:x.Smax+1 })},
      {label:"+0.05 pilot-from-sprint", apply:(x)=>({ ...x, p:Math.min(1, x.p+0.05) })},
      {label:"+0.05 retainer-from-pilot", apply:(x)=>({ ...x, r:Math.min(1, x.r+0.05) })}
    ];

    const tbody = $("sensRows");
    tbody.innerHTML = "";
    tests.forEach(t=>{
      const m2 = model(t.apply(inp));
      const dYear = m2.bookingsYear - baseYear;
      const dMo = dYear / 12;

      const tr = document.createElement("tr");
      const td0 = document.createElement("td"); td0.textContent = t.label;
      const td1 = document.createElement("td"); td1.textContent = fmtMoneySigned(dYear); td1.className = dYear>=0 ? "pos":"neg";
      const td2 = document.createElement("td"); td2.textContent = fmtMoneySigned(dMo); td2.className = dMo>=0 ? "pos":"neg";
      tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2);
      tbody.appendChild(tr);
    });
  }

  function update(){
    const inp = readInputs();
    const out = model(inp);

    $("kBookings").textContent = fmtMoney(out.bookingsMo);
    $("kBookingsYear").textContent = fmtMoney(out.bookingsYear);
    $("kNewMRR").textContent = fmtMoney(out.newMRRMo);
    $("kMRRHor").textContent = fmtMoney(out.mrrHorizon);
    $("kCashIn").textContent = fmtMoney(out.cashInMoHorizon);
    $("kCashInYear").textContent = fmtMoney(out.cashInYearHorizon);

    $("kVolumes").innerHTML =
      "Expected volumes / month<br/>" +
      "Qualified: <b>" + out.qualified.toFixed(2) + "</b>" +
      " • Sprints: <b>" + out.sprints.toFixed(2) + "</b> (raw " + out.sprintsRaw.toFixed(2) + ")" +
      " • Pilots: <b>" + out.pilots.toFixed(2) + "</b> (raw " + out.pilotsRaw.toFixed(2) + ")" +
      " • New retainers: <b>" + out.newRetainers.toFixed(3) + "</b>";

    $("kMRRTrack").innerHTML =
      "MRR accumulation<br/>" +
      "Starting: <b>" + fmtMoney(inp.m0) + "</b>" +
      " • MRR @ 3 mo: <b>" + fmtMoney(out.mrr3) + "</b>" +
      " • MRR @ 6 mo: <b>" + fmtMoney(out.mrr6) + "</b>" +
      " • MRR @ 12 mo: <b>" + fmtMoney(out.mrr12) + "</b>" +
      " • MRR @ horizon: <b>" + fmtMoney(out.mrrHorizon) + "</b>";

    const board =
      "Plan: " + fmtMoney(out.bookingsMo) + "/mo bookings → " + fmtMoney(out.bookingsYear) + "/yr. " +
      "Adds " + fmtMoney(out.newMRRMo) + "/mo new contracted MRR; MRR @ " + inp.months + " mo: " + fmtMoney(out.mrrHorizon) + ". " +
      "Cash-in @ horizon: " + fmtMoney(out.cashInMoHorizon) + "/mo (" + fmtMoney(out.cashInYearHorizon) + "/yr).";
    $("kBoard").textContent = board;

    sensTable(inp);

    // Assumption audit (simple + explicit)
    const aud = $("auditBody");
    aud.innerHTML = "";
    aud.appendChild(auditRow("Qualified rate (q)", inp.q.toFixed(2), "Med", "How many leads are actually in-scope."));
    aud.appendChild(auditRow("Sprint close (s)", inp.s.toFixed(2), "Med", "Conversion from qualified to paid sprint."));
    aud.appendChild(auditRow("Pilot-from-sprint (p)", inp.p.toFixed(2), "Med", "Who extends from sprint into pilot."));
    aud.appendChild(auditRow("Retainer-from-pilot (r)", inp.r.toFixed(2), "Med", "Pilot → ongoing retainer conversion."));
    aud.appendChild(auditRow("Churn (c)", (inp.c*100).toFixed(1) + "%", "Low", "Until you have 6–12 months data."));
    aud.appendChild(auditRow("Capacity caps", "Smax=" + inp.Smax + ", Pmax=" + inp.Pmax, "High", "Your time/ops reality (non-negotiable)."));

    // keep preset selector honest if user tweaks values manually (no forcing)
  }

  function attach(){
    // live update on input changes
    const ids = ["preset","sym","months","m0","L","q","s","p","r","c","sprintPrice","pilotPrice","retainerMonth","Smax","Pmax","cost","notes"];
    ids.forEach(id=>{
      const el = $(id);
      el.addEventListener("input", ()=>update());
      el.addEventListener("change", ()=>{
        if(id==="preset") setPreset($("preset").value);
        else update();
      });
    });

    $("btnToggle").addEventListener("click", ()=>{
      $("cardInputs").classList.toggle("hide");
    });

    $("btnPrint").addEventListener("click", ()=>window.print());

    $("btnCopy").addEventListener("click", ()=>{
      copyText($("kBoard").textContent || "");
    });

    $("btnReset").addEventListener("click", ()=>{
      $("preset").value = "base";
      setPreset("base");
      $("notes").value = "";
      update();
    });

    $("btnSaveLS").addEventListener("click", ()=>saveLS());
    $("btnLoadLS").addEventListener("click", ()=>loadLS());
    $("btnDefaults").addEventListener("click", ()=>{
      localStorage.removeItem(KEY);
      $("preset").value = "base";
      setPreset("base");
      $("notes").value = "";
      update();
    });
  }

  // boot
  attach();
  // try to load saved state; fall back to base
  if(!loadLS()){
    $("preset").value = "base";
    setPreset("base");
  }
  update();
})();
</script>

<script src="_os/qds_os.js"></script>
</body>
</html>
